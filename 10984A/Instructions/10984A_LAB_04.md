# Module 4: Exchange Server hybrid deployment
# Lab: Implement the Exchange Server hybrid deployment
  
### Scenario
  Adatum Corporation is now ready to implement Exchange Online in the hybrid configuration with on-premises Exchange Server. You decided to use the **Hybrid Configuration Wizard** to prepare the environment and deploy the hybrid configuration. After establishing the hybrid environment, you'll need to move several pilot mailboxes from on-premises Exchange Server to Exchange Online. Also, you need to explore the options for DLP in Exchange Online.

### Objectives
  After completing this lab, you will be able to:

- Use the **Hybrid Configuration Wizard**.
- Move mailboxes between Exchange Server on-premises and Exchange Online.
- Configure options for message compliance and security enhancement.

> **Note:** The lab steps for this course change frequently due to updates to Microsoft Office 365. Microsoft Worldwide Learning updates the lab steps frequently, so they are not available in this manual. Your instructor will provide you with the lab documentation.


> **Note:** Please note, at the time of this course's development, Microsoft was rebranding the Office 365 Admin center. In most instances, the Office 365 Admin center now is called the Microsoft 365 admin center. However, you may encounter instances of Office 365 Admin center in this course, particularly in the user interface in labs. Don't assume you're in the wrong portal if you encounter instances of Office 365 Admin center. For this course, the two names refer to the same admin center.

### Lab setup
Estimated time: 75 minutes

Virtual machines: **10984A-LON-DC1**, **10984A-LON-DS1**, **10984A-LON-WAP1**, **10984A-LON-EX1**, and **10984A-LON-CL1**

For LON-DC1, LON-DS1, and LON-EX1:

- Username: **Adatum\\Administrator**
- Password: **Pa55w.rd**

For LON-WAP1:

- Username: **LON-WAP1\\Administrator**
- Password: **Pa55w.rd**

For LON-CL1:

- Username: **Adatum\\Beth**
- Password: **Pa55w.rd**

To perform this lab, you must have completed the labs in Module 1, "Introduction to Office 365 administration and licensing," Module 2, "Deploying and configuring directory synchronization" and Module 3, "Exchange Server hybrid deployment planning."

The virtual machines are listed as follows: \(use only the VMs required for your lab\)

- LON-DC1:

  - Sign in as **Adatum\\Administrator** using the password **Pa55w.rd**

- LON-DS1:

  - Sign in as **Adatum\\Administrator** using the password **Pa55w.rd**

- LON-WAP1

  - Sign in as **LON-WAP1\\Administrator** using the password **Pa55w.rd**

- LON-EX1

  - Sign in as **Adatum\\Administrator** using the password **Pa55w.rd**

- LON-CL1

  - Sign in as **Adatum\\Beth** using the password **Pa55w.rd**


## Exercise 1: Using the Hybrid Configuration Wizard
  
### Scenario

  Before starting the **Hybrid Configuration Wizard**, you need to verify the setup and functionality of your current Exchange Server 2016 deployment. Then, you need to run the **Hybrid Configuration Wizard** to establish the hybrid environment.

The main tasks for this exercise are as follows:

1. Verify public accessibility
2. Use the Exchange admin center to verify on-premises deployment
3. Run the Hybrid Configuration Wizard
4. Review the changes that the Hybrid Configuration Wizard made


#### Task 1: Verify public accessibility
  

1. On **LON-WAP1**, already signed in as **LON-WAP1\\Administrator**, open Internet Explorer, navigate to **bing.com**, type **What is My IP** in the **Search** box, and then document the public IP address displayed for the **LON-WAP1** server. You will need this IP address later.
2. If an Internet Explorer dialog box open, Click **Yes**.
3. Close the **Internet Explorer** window.
4. On **LON-CL1**, sign in as **Adatum\\Beth** with the passsword **Pa55w.rd**, from the taskbar, open Microsoft Edge, and then navigate to [https://aka.ms/AA2p30o](https://aka.ms/AA2p30o).
5. In the **Microsoft Remote Connectivity Analyzer** window, run the **Synchronization, Notification, Availability, and Automatic Replies** test. Specify the following:

  - Email address: **abbi\@Adatumyyxxxxx.hostdomain.com**
  - Domain\\User Name (or UPN): **abbi\@Adatumyyxxxxx.hostdomain.com**
  - Password: **Moc10984A**
  - Confirm Password: **Moc10984A**
  - Select the **I understand that I must use the credentials of a working account from my Exchange domain to be able to test connectivity to it remotely. I also acknowledge that I am responsible for the management and security of this account** check box.

6. Type the verification characters select **Verify**, and then select **Perform Test**.

  > **Note:** You should receive a "Connectivity Test Successful with Warnings" message. This indicates that on-premises Exchange Web Services is accessible.
  > If you do receive an error, verify that DNS records were created on LON-DC1 that matches the SMTP domain for Abbi\@Adatum.

7. Select **Start Over** to go back to the **Exchange Server** tab.
8. Run the **Outlook Autodiscover** test, specifying the following:

  - Email address: **abbi\@Adatumyyxxxxx.hostdomain.com**
  - Domain\\User Name (or UPN): **abbi\@Adatumyyxxxxx.hostdomain.com**
  - Password: **Moc10984A**
  - Confirm Password: **Moc10984A**
  - Select the **I understand that I must use the credentials of a working account from my Exchange domain to be able to test connectivity to it remotely. I also acknowledge that I am responsible for the management and security of this account** check box.

9. If necessary, type the verification characters, select **Verify**, and then select **Perform Test**.
10. In the **Test Details** section, select **Expand All**, locate the **Attempting to resolve the host name adatumyyxxxxx.hostdomain.com in DNS** test step, and then compare the IP addresses returned in this test step to the one you documented in step 1. If it matches one of the addresses, you have connected to your on-premises server by using Outlook Anywhere.

  > **Note:** You should receive a "Connectivity Test Successful with Warnings" message.
  > Selecting the **Ignore Trust for SSL** check box would allow this test to succeed even if your certificate is not trusted.

11. Select **Start Over**, and then run the **Inbound SMTP E-Mail** test by using the following email address in the **Inbound SMTP E-Mail** window: **abbi\@adatumyyxxxxx.hostdomain.com**.
12. If necessary, type the verification characters, and then select **Verify**. Select **Perform Test**.

  > **Note:** You should receive a "Connectivity Test Successful" message.
  > SMTP uses opportunistic TLS by default. Even if the Microsoft Remote Connectivity Analyzer does not trust the certificate, the test message will still succeed.

13. In the **Test Details** window, select **Expand All**, scroll to the last test performed, and then verify that the following message appears: "The Open Relay test passed. This MX isn't an open relay.".
14. Exit the Remote Connectivity Analyzer by closing Microsoft Edge.
15. On **LON-EX1**, already signed in as **Adatum\\Administrator**, from the taskbar, open the Exchange Management Shell.
16. In the **Exchange Management Shell** window, run the following command, and then press Enter:

  ```
  Get-ExchangeCertificate | Where-Object {$_.Subject -match "^CN=\*"} | Format-List
  ```

17. In the **Exchange Management Shell** window, confirm the certificate that on-premises Microsoft Exchange Server uses by reviewing the results for the following attributes:

  - IsSelfSigned: **False**
  - NotAfter: _date not expired_
  - Status: **Valid**
  - Services: **SMTP**

  > **Note:** It is a good idea to document the thumbprint for the certificate that Exchange Server used. Event logs typically reference a certificate thumbprint, rather than the subject or friendly name, in warnings and error messages. This is also helpful when multiple certificates with the same subject name exist.
  > In your production environments, you also want to make sure that **Issuer** is a trusted third party public certificate authority so Microsoft Exchange Online can trust the certificate.

18. Leave the **Exchange Management Shell** window open.


#### Task 2: Use the Exchange admin center to verify on-premises deployment
  
1. On **LON-CL1**, open Microsoft Edge, and then navigate to **https://portal.office.com/AdminPortal/Home**. Sign in as **beth\@adatumyyxxxx.onmicrosoft.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing."
2. On **LON-EX1**, open the Exchange admin center, and then sign in as **Adatum\\Administrator** with the password **Pa55w.rd**.
3. On the navigation menu on the left side, select **Permissions**.
4. In the **admin roles** list, double-click **Organization Management**.
5. On the **Organization Management** page, scroll down to the **Members** section. Confirm that**Administrator** is a member.
6. Return to the **admin roles** list, and then double-click the **Compliance Management** admin role. Note whether this group has any members.

  > **Note:** By default, this group has no members. If your production environment lists any administrators, document them so you can grant them the equivalent role in Exchange Online.

7. To return to admin roles list, click **Cancel**.
8. In the navigation pane on the left side, select **organization**.
9. On the **sharing** tab, review the default settings. Note that no organization relationship is set up.
10. On the navigation menu on the left side, select **mail flow**.
11. On the **mail flow** page, select the **accepted domains** tab. Note the **Accepted Domain** and **Domain Type** fields for each domain in the list.
12. On the **mail flow** page, select the **receive connectors** tab. Note that five Receive connectors exist:

  - **Client Frontend LON-EX1 - FrontendTransport**
  - **Default frontend LON-EX1 - FrontendTransport**
  - **Outbound Proxy Frontend LON-EX1 - Frontend Transport**
  - **Client Proxy LON-EX1 - HubTransport**
  - **Default LON-EX1 -HubTransport**

13. On the **mail flow** page, select the **send connectors** tab. Note that one connector exists.

  > **Note:** By running the **Hybrid Configuration Wizard**, you will create specific connectors in Exchange Online and on-premises for the hybrid environment.

14. On the navigation menu on the left side, select **unified messaging**. Check if there is a Unified Messaging (UM) dial plan configured.
15. In the navigation pane on the left side, select **servers**. Document the version of the on-premises server. ___________________________
16. In Internet Explorer, open a new tab, navigate to [https://aka.ms/AA216yr](https://aka.ms/AA216yr), and then locate the product and cumulative update or rollup that matches the build number displayed in the Exchange admin center.

  > **Note:** Remember that the version of Exchange Server you are running impacts the version of**Hybrid Configuration Wizard** you can use and the features that your hybrid deployment makes available.

17. Switch to the **servers - Microsoft Exchange Admin Center** tab.
18. In the navigation pane on the left side, select **hybrid**. Note that you can access the **Hybrid Configuration Wizard** web app here in Exchange Server 2016 on-premises. The same option is available in Microsoft Office 365.
19. Leave Internet Explorer open. You will need the Exchange admin center for the following task.


#### Task 3: Run the Hybrid Configuration Wizard
  
1. On **LON-EX1**, already signed in as **Adatum\\Administrator**, note the Exchange admin center still be open from the previous task. If it isn't, open Internet Explorer, and then navigate to **https://lon-ex1.adatum.com/ecp**.
2. In the navigation pane on the left side, select **hybrid**. Clear the **My Office 365 organization is hosted by 21Vianet** check box, and then select **configure**.
3. In the **information** dialog box, select **sign in to Office 365**.
4. In the **Sign in** dialog box, type**beth\@adatumyyxxxx.onmicrosoft.com**, select **Next**, type the password that you created in the lab in Module 1, "Introduction to Office 365 administration and licensing," and then select **Sign in**.
5. On the **Enterprise** tab, in the navigation pane on the left side, select **hybrid**, and then select **configure**.

  > **Note:** If you receive an error "application is improperly formatted", add the **https://mshrcstorageprod.blob.core.windows.net** website as a trusted site in the Internet Explorer security settings.

6. In the **Application Install - Security Warning** window, select **Install**. If the **Do you want to run this file** dialog box appears, select **Run**.
7. On the **Hybrid Configuration Wizard** page, select **next**.
8. On the **On-premises Exchange Server Organization** page, verify that **Detect the optimal Exchange server** is selected and that **LON-EX1** is detected. Verify that **Office 365 Worldwide** is selected for **Office 365 Exchange Online**, and then select **next**.
9. On the **On-premises Exchange Account** page, confirm that **Adatum\\Administrator** is selected. If it is not, select **enter** and enter the credentials. Under the **Office 365 Exchange Online account** section, select **sign in**, sign in as **beth\@adatumyyxxxx.onmicrosoft.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing," and then select **next**.
10. On the **Gathering Configuration Information** page, wait for the process to complete, and then select **next**.
11. On the **Hybrid Features** page, select **Full Hybrid Configuration**, select **Organization Configuration Transfer**, and then select **next**.
12. On the **Federation Trust** page, select **enable**.
13. On the **Domain Ownership** page, select **Copy to notepad**.
14. When Notepad opens, select **File**, select **Save as**, select the **C:\\Labfiles\\Mod04** folder, type **TXTProof.txt** in the **File name** box, and then select **Save**.
15. On **LON-DC1**, open File Explorer, and then in the **path** field, type **\\\\LON-EX1\\C$\\Labfiles\\Mod04**. To access the domain proof, double-click **TXTproof.txt**.
16. In the **Space Separated** section, select and copy the string value. Do not include the custom domain name.
17. From the taskbar, open the DNS Manager tool.
18. To add a TXT record, expand the **LON-DC1** node, expand **Forward Lookup Zones**, select the custom domain zone (for example, **adatumyyxxxxx.hostdomain.com**), right-click the zone, select **Other New Records**, select **Text (TXT)** in the list, and then select **Create Record**.
19. In the **New Resource Record** window, in the **Text** section, paste the text proof string. It should have no leading spaces and end with two equal signs (==). Select **OK** to create the record. Select **Done** to close the **Resource Record Type** window.
20. On **LON-EX1**, return to the **Domain Ownership** page, select the **I have created a TXT record for each token in DNS** check box, and then select **verify domain ownership**.
21. On the **Hybrid Configuration** page, leave the **Configure my Client Access and Mailbox servers for secure mail transport (typical)** default option selected, and then select **next**.
22. On the **Receive Connector Configuration** page, select the drop-down box arrow, select the check box for **LON-EX1**, and then select **next**.
23. On the **Send Connector Configuration** page, select the drop-down box arrow, select the check box for **LON-EX1**, and then select **next**.
24. On the **Transport Certificate** page, select the drop-down box arrow, select the wildcard certificate for _.hostdomain.com_, and then select **next**.
25. On the **Organization FQDN** page, type **adatumyyxxxxx.hostdomain.com**, and then select **next**.
26. On the **Ready for Update** page, select **update**.
27. Wait for the **Hybrid Configuration Wizard** to complete. On the **Congratulations** page select **close**.


#### Task 4: Review the changes that the Hybrid Configuration Wizard made
  
1. On **LON-EX1**, open the Exchange admin center. If prompted, sign in as **Adatum\\Administrator** with the password **Pa55w.rd**.
2. In the **Exchange admin center** window, select **Enterprise**.
3. On the navigation menu on the left side, select **organization**.
4. On the **sharing** tab, review the changes.
5. Under **Organization Sharing**, select the **On-premises to O365** policy, select **Edit** (the pencil icon), review the **general** and **sharing** settings, and then select **cancel**. Note that under **Domains**, the domain name is the online domain name.
6. Under **Individual Sharing**, select the **Default Sharing Policy (DEFAULT)** policy, and then select **Edit**. Review the sharing policy settings, and then select **cancel**.
7. On the navigation menu on the left side, select **mail flow**.
8. On the **mail flow** page, select the **accepted domains** tab. Note the new accepted domain that the **Hybrid Configuration Wizard** added.
9. On the **mail flow** page, select the **send connectors** tab. Note the new connector: **Outbound to Office 365**.
10. Double-click **Outbound to Office 365**, select **scoping**, and then under **Address space**, confirm that the only domain listed is **adatumyyxxxxx.mail.onmicrosoft.com**. Note that this matches the new accepted domain.
11. To close the **Outbound to Office 365** window, select **cancel**.
12. To verify that you are viewing the online environment, select **Office 365** in the **Exchange admin center** window.

  > **Note:** When you select the **Office 365** tab, you might be prompted to sign in to Office 365. If so, sign in as **beth\@adatumyyxxxx.onmicrosoft.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing."

13. On the navigation menu on the left side, select **organization**.
14. On the **sharing** tab, review the changes.
15. Under **Organization Sharing**, select the **O365 to On-Premises** policy, select **Edit** (the pencil icon), review the **general** and **sharing** settings, and then select **cancel**. Note that under **Domains**, the domain listed is the on-premises domain name.
16. Under **Individual Sharing**, select the **Default Sharing Policy (DEFAULT)** policy, and then select **Edit**. Review the sharing policy settings and then select **cancel**.
17. On the navigation menu on the left side, select **mail flow**.
18. On the **mail flow** page, select the **accepted domains** tab. Note the new accepted domain that the **Hybrid Configuration Wizard** added.
19. On the **mail flow** page, select the **connectors** tab. Note the new Inbound and Outbound connectors that the **Hybrid Configuration Wizard** created.
20. To review the settings of the Inbound connector, select the name that starts with **Inbound from**, and then view the details pane.
21. To review the settings of the Outbound connector, select the name that starts with **Outbound to**, and then view the details pane.
22. Leave the Exchange admin center open. You will need it for the next exercise.
23. On the taskbar, select the **Exchange Management Shell** icon.
24. In the Exchange Management Shell, type the following command, and then press Enter:

  ```
  Get-HybridConfiguration
  ```

25. Review the results, and then close the **Exchange Management Shell** window.

> **Result**: After completing this exercise, you should have verified the on-premises deployment and run the Hybrid Configuration Wizard.


## Exercise 2: Move mailboxes between Exchange on-premises and Exchange Online
  
### Scenario
  After you have established the Exchange hybrid environment, you need to move mailboxes for several users and then verify the functionality of these mailboxes after the move process is finalized. In this exercise, you will prepare the mailboxes for onboarding to Exchange Online from your on-premises environment, and you will check the mailboxes' functionality.


The main tasks for this exercise are as follows:

1. Move mailboxes to Exchange Online
2. Verify mailboxes functionality and mail flow


#### Task 1: Move mailboxes to Exchange Online
  
1. On **LON-EX1**, already signed in as **Adatum\\Administrator**, open the Exchange admin center. If prompted, sign in as **Adatum\\Administrator** with the password **Pa55w.rd**.
2. Open the Exchange Management Shell, and then type the following command for **Adam**, **Abbi**, **Allan**, **Cai**, **Ella**, and **Jon**, pressing Enter after each command: 

  ```
  Set-Mailbox "username" -EmailAddresses \@{remove="username\@adatum.com"}
  ```

3. On **LON-DS1**, select **Start**, expand **Azure AD Connect**, and then select **Synchronization Service**.
4. In the **Synchronization Service Manager on LON-DS1** window, select the **Connectors** tab, double-click **Adatum.com**, select **Configure Directory Partitions**, and then select **Containers**.
5. In the **Credentials** dialog box, type **Administrator** for the **User name**, type **Pa55w.rd** for the **passsword **, and then select **OK**.
6. In the **Select Containers** window, confirm that **IT** and **Research** are selected, add the following containers, and then select **OK**:

  - **Development**
  - **Managers**
  - **Marketing**
  - **Sales**

7. To close the **Properties** window, select **OK**.
8. Click **Start**, select **Windows PowerShell**, type the following command, and then press Enter:

  ```
  Start-ADSyncSyncCycle -PolicyType Initial
  ```

9. Switch back to the **Synchronization Service Manager on LON-DS1** window, select the **Operations** tab, and then review the six connector operations \(**Full Import, Full Import, Full Synchronization, Full Synchronization, Export, Export**\).
10. Close the **Synchronization Service Manager** window.

  > **Note:** Expect around 200 new **Adds** (users and groups) to synchronize from **Adatum.com** to your Office 365 tenant. You might receive one or two export errors that you can ignore.
  > Synchronizing user accounts before they are migrated is an important prerequisite to moving a mailbox. If you don't do this, you might end up with duplicate accounts for your users.

11. On **LON-EX1**, open the Exchange admin center. If prompted, sign in as **Adatum\\Administrator** with the password **Pa55w.rd**.
12. To verify that you are viewing the online environment, select **Office 365** in the **Exchange admin center** window. If prompted, sign in as **beth\@adatumyyxxxx.onmicrosoft.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing."
13. In the **Exchange admin center** window, select **recipients**, select **Migration**, select **More** (the ellipsis icon), and then select **Migration endpoints**.
14. On the **Migration Endpoints** page, verify that the **Hybrid Migration Endpoint** was created and then click **Close**.

  > **Note:** You must use Outlook Anywhere only in a cutover or staged migration and not a hybrid migration.
  > The **Hybrid Configuration Wizard** automatically creates a hybrid migration endpoint to **mail.adatumyyxxxxx.hostdomain.com**.

15. Select **Add** (the plus icon), and then select **Migrate to Exchange Online**.
16. On the **Select a migration type** page, select **Remote move migration (supported by Exchange Server 2010 and later versions)**, and then select **Next**.
17. On the **Select the users** page, select **Add** (the plus sign icon), and then on the **Select Mail User** page, double-click **Adam Hobbs**, **Abbi Skinner**, **Allan Yoo**, **Cai Chu**, **Ella Perry**, and **Jon Friday**. Select **add**, and then select **OK**.
18. On the **Select the users** page, select **Next**.
19. On the **Confirm the migration endpoint** page, select **Next**. You will find the result as **adatumyyxxxx.hostdomain.com**.
20. On the **Move configuration** page, enter the following information, and then select **Next**:

  - New migration batch name: **First Batch**
  - Target delivery domain: **adatumyyxxxx.mail.onmicrosoft.com**
  - Archive: **Move the primary mailbox and the archive mailbox if one exists**
  - Bad item limit: **10**
  - Large item limit: null

21. On the **Start the batch** page, under the **Please select the preferred option to complete the batch** section, select **Automatically complete the migration batch**. Leave all other settings at their default values, and then select **new**.
22. On the **migration** page, monitor the status of **First Batch**. Periodically use the **Refresh** button until the status changes to **Completed**. The expected results are **Finalized 6** and **Failed 0**.

  > **Note:** This process can take up to 30 minutes to complete. Skip to Exercise 3, and return to complete this exercise later.

23. On the **migration** page, select **First Batch**, select **Delete** (the trash can icon), and then on the **Warning** page, select **Yes**.
24. In Internet Explorer, open a new tab, and then navigate to **https://portal.office.com/adminportal/home**. If prompted to sign in, sign in as **beth\@adatumyyxxxxx.hostdomain.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing."
25. Select **Users**, select **Active users**, and then select the check boxes for **Abbi Skinner**, **Adam Hobbs**, **Allan Yoo**, **Cai Chu**, **Ella Perry**, and **Jon Friday**.
26. On the **Bulk actions** page, select **Edit product licenses**, and then on the **Assign products** page, select **Add to existing product license assignments**. Select **Next**.
27. On the **Add to existing products** page, in the box, select **United States**, move the slider to enable **Office 365 Enterprise E5**, scroll down, and then select **Add**.
28. When you receive the note "We couldn't replace the products for everyone you selected" review the affected user and then click **Close**.


#### Task 2: Verify mailboxes functionality and mail flow

1. On **LON-CL1**, sign out current user (Adatum\\Beth).
2. On **LON-CL1**, sign in as **adam\@adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
3. Open Outlook 2016.
4. On the **Add an Email Account** page, add a new account by using **Auto Account Setup**, and then select **Finish**.

  > **Note:** If the **Microsoft Office Activation Wizard** appears, select **Close**. If the **First things First** page appears, select **Ask me later**, and then select **Accept**.

5. If the **Allow this website to configure adam\@adatumyyxxxxx.hostmail.com server settings?** dialog box appears, select **Allow**.
6. In Outlook, send an email to **Holly** with the subject **Hybrid Test 1** and **Online to on-premises** in the body of the message.
7. On the bottom navigation bar, select **Calendar**, and then on the ribbon, select **New Appointment**.
8. In the **Untitled - Appointment** window, on the **Subject** line, type **Hybrid Deployment**. Set the **Start time** to **today** at **4:30 pm** and the **End time** to **today** at **5:30 pm**.
9. Select **Save &amp; Close**.
10. On the bottom navigation bar, select **Mail**.
11. On **LON-CL2**, sign in as **holly\@adatumyyxxxxx.hostdomain.com** with the password **Pa55w.rd**.
12. Open Microsoft Outlook, and on the **Add an Email Account** page, add an account by using **Auto Account Setup**.
13. On the **Searching for your mail server settings** page, select **Finish**.

  > **Note:** If the **Microsoft Office Activation Wizard** appears, select **Close**. If the **First things First** page appears, select **Ask me later**, and then select **Accept**.

14. In Outlook, confirm that Holly received the email from Adam. This verifies that the hybrid connectors are working from online to on-premises.
15. In Outlook, send an email to **Adam** with the subject **Hybrid Test 2** and **On-premises to online** in the body of the message.
16. On the bottom navigation bar, select **Calendar**.
17. On the ribbon, select **New Meeting**.
18. In the **Untitled-Meeting** window, type **Adam Hobbs** on the **To** line, type **Hybrid Status Meeting** on the **Subject** line, and then type **Online** on the **Location** line.
19. Set **Start time** to **today** at **4:00 pm** and the **End Time** to **today** at **5:00 pm**.
20. Select **Scheduling Assistant**. Note that Adam shows as busy from 4:30 through 5:30 PM today.
21. In the lower right, under **Suggested times**, scroll down, and then select **3:30 PM - 4:30 PM No conflicts**.
22. Select **Send**.

  > **Note:** The ability for Holly to see Adam's free/busy information verifies that the organizational relationship from online to on-premises is working for the hybrid configuration.

23. On **LON-CL1**, open Outlook.

  > **Note:** If **Microsoft Office Activation Wizard** appears, select **Close**.

24. In Outlook, confirm that Adam received the emails from Holly. This verifies that the hybrid connectors are working from on-premises to online.
25. Select **Hybrid Status Meeting**, select **Propose New Time**, and then select **Tentative and Propose New Time**. Note that Adam's free/busy information is visible.
26. Select **AutoPick Next**, select **Propose Time**, and then in the **New Time Proposed: Hybrid Status Meeting - Meeting Response** window, select **Send**. The expected result is a proposal for tomorrow from 8:00 AM through 9:00 AM.

  > **Note:** You have successfully verified the functionality and mail flow in a hybrid configuration. If you have already completed the Exercise 3 tasks, proceed to the "Prepare for the next module" task at the end of Exercise 3.

> **Result**: After completing this exercise, you should have moved mailboxes for onboarding to Exchange Online from your on-premises environment.


## Exercise 3: Configure message compliance and security in the hybrid environment
  
### Scenario
  After you move mailboxes to Exchange Online, you need to explore some additional options for using Exchange Online in the hybrid environment. You want to evaluate the use of Exchange Online as an archive solution and its use in message security and in supporting compliance.

The main tasks for this exercise are as follows:

1. Deploy the message archive in Exchange Online
2. Configure DLP
3. Configure an In-Place Hold
4. Prepare for the next module


#### Task 1: Deploy the message archive in Exchange Online
 
1. On **LON-EX1**, open Internet Explorer, and then navigate to **https://portal.office.com/adminportal/home**. Sign in as **beth\@adatumyyxxxx.onmicrosoft.com** with the password you created in the lab in Module 1, "Introduction to Office 365 administration and licensing."
2. In the navigation pane on the left side, select **Billing**, select **Purchase services**, and then start a free trial for **Exchange Online Archiving for Exchange Server**.

  > **Note:** The Exchange Online Archiving for Exchange Server trial includes 25 licenses. You can use these for up to 30 days of testing.

3. Select **Users**, select **Active users**, select the **Holly Spencer** check box, and then next to **Product licenses**, select **Edit**.
4. Under **Location**, select **Untied States**.
5. To enable the Exchange Online Archiving for Exchange server license, move the slider.
6. Return to the **Active users** window.
7. Open the Exchange admin center.
8. To verify that you are viewing the on-premises environment, select **Enterprise** in the **Exchange admin center** window.
9. In the navigation pane on the left side, select **Recipients**, select the **Mailboxes** tab, select **Holly Spencer**, and then in the details pane, under the **In-Place Archive** section, select **Enable**.
10. In the **create in-place archive** dialog box, select **Cloud-based archive: adatumyyxxxxx.mail.onmicrosoft.com**, and then select **ok**. Note that the **Mailbox Type** changes to **User (Archive)**.

  > **Note:** It takes up to 30 minutes for the archive mailbox to provision for users in Exchange Online. For now, continue with the next task.

11. Leave the Exchange admin center open, because you will need it in the next task.


#### Task 2: Configure DLP
  

1. On **LON-EX1**, already signed in as **Adatum\\Administrator**, open the Exchange admin center, and then select **Enterprise**.
2. Select **compliance management**.
3. Select the **data loss prevention** tab.
4. Create a new Custom DLP policy with the name **Restrict financial data flow**.
5. In the **Exchange admin center** window, select **Restrict financial data flow**, and then select **Edit**.
6. In the **edit DLP policy** window, on the **general** tab, select **Enforce**.
7. Select **rules**.
8. Next to **New**, select the arrow, and then select **Block messages with sensitive information unless the sender overrides**.
9. In the **new rule** window, select **Select sensitive information types**. In the **Contains any of these sensitive information types** window, select **Add**, and then in the **Sensitive Information types** list, select **Credit Card Number**. Select **add**, and then select **OK** twice.
10. In the **new rule** window, in the **Do the following** section, in the box, select **Block the message**, and then select **reject the message and include an explanation**.
11. In the **specify rejection reason** window, type **This message contains financial information and can't be sent outside the organization**, and then select **OK**.
12. On the right side of the **Generate incident report and send it to** box, select **Select one**.
13. In the **Select Members** window, select **Beth Burke**, and then select **OK**.
14. On the right side of the box, select **Custom content**.
15. In the **Include message properties** window, select **original mail**, **matching rules**, select **matching content**, and then select **OK**.
16. Scroll down, and then select **Activate this rule on the following date**. Next to date, select the arrow, and then select **today**.
17. In the **Choose a mode for this rule** list, select **Enforce**.
18. Select **Save**. If a warning window appears, select **OK**, and then select **Save** again.
19. Above the **Restrict financial data flow** policy, select **Customize Policy Tips** (on the toolbar, the fourth icon from the left side).
20. In the **Policy Tips** window, select **New**.
21. In the **New Policy Tip setting** window, under **Policy Tip**, select **Notify the sender**.
22. In the **Locale** box, select **English**.
23. In the **Text** box, type **This message contains information that you are not allowed to send**.
24. Select **Save**, and then select **Close**.

  > **Note:** In a hybrid configuration, you have to repeat cross-premises any changes you make to data loss prevention (DLP) policies. In this case, you created a new custom DLP policy on-premises. However, you need to create this policy online to help protect the mailboxes that you move to Exchange Online.

25. Open the Exchange Management Shell.
26. Type the following command, and then press Enter:

  ```
  Get-DlpPolicy
  ```

27. To export this policy, type the following command, and then press Enter:

  ```
  $file = Export-DlpPolicyCollection -Identity "Restrict financial data flow"; Set-Content -Path "C:\Labfiles\Mod04\EnterpriseDLP.xml" -Value $file.FileData -Encoding Byte
  ```

28. Open Windows PowerShell, and then sign in as **beth\@adatumyyxxxx.onmicrosoft.com** by running the following commands:

  ```
  $Creds = Get-Credential
  ```

  ```
  $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $Creds -Authentication Basic -AllowRedirection
  ```

  ```
  Import-PSSession $Session -AllowClobber
  ```

  > **Note:** You can safely disregard warning about unapproved verbs.

29. Type the following command, and then press Enter:

  ```
   Get-DlpPolicy
  ```

30. Import the custom DLP policy into Exchange Online via this command:

  ```
  Import-DlpPolicyCollection -FileData ([Byte[]]$(Get-Content -Path "C:\Labfiles\Mod04\EnterpriseDLP.xml" -Encoding Byte -ReadCount 0))
  ```

31. Confirm that the policy was imported via this command:

  ```
  Get-DlpPolicy | Format-List
  ```

32. To disconnect your session, type the following command, and then press Enter:

  ```
  Remove-PSSession $Session
  ```

33. Close the Windows PowerShell window.


#### Task 3: Configure an In-Place Hold
 
1. On **LON-DC1**, open **Active Directory Users and Computers**.
2. Expand **Adatum.com**, and then select **Microsoft Exchange Security Groups**.
3. Add Beth to the **Discovery Management** and **Organization Management** groups.
4. On **LON-EX1**, open the Exchange admin center, select **Enterprise**, and then in the navigation pane on the left side, select **permissions**.
5. On the **admin roles** tab, double-click **Discovery Management**.
6. In the **Role Group** window, ensure that **Beth Burke** is in the **Members** list. Close the **Role Group** window.
7. In the **Exchange admin center** window, select **Office 365**, and then select **permissions**.
8. Select the **admin roles** tab.
9. Double-click **Discovery Management**.
10. In the **Role Group** window, in the **Members** list, select **Add** (the plus sign icon).
11. In the **Select Members** window, select **Beth**, select **add**, select **OK**, and then in the **Role Group** window, select **Save**.

  > **Note:** Beth now has Organization Management and Discovery Management permissions on-premises and online. This allows Beth to perform criteria-based In-Place Holds and litigation holds. For the permissions to take effect, you need to close and reopen the Exchange admin center.

12. Close the Exchange admin center.
13. Open the Exchange admin center, and then sign in as **Adatum\\Beth** with the passsword **Pa55w.rd**. In the **Language** field, select **English (United States)**, select your time zone, and then select **save**.
14. In the **Exchange admin center** window, select **Enterprise**, and then select **compliance management**.
15. On the toolbar, select **New**, type **R&amp;D data preservation**, and then select **Next**.
16. On the **mailboxes** page, select **Specify mailboxes to search**, and then select **Add**.
17. In the **Select Mailbox** window, add mailboxes for users**Cai Chu**, **Jon Friday**, **Adam Hobbs**, select **OK**, and then select **Next**.
18. On the **Search query** page, select **Filter based on criteria**. In the **Keywords** box, type **ProjectX**.
19. Select **select message types**, select **Select the message types to search**, and then select **Email**.
20. Select **OK**, and then select **Next**.
21. On the **In-Place Hold settings** page, select **Place content matching the search query in selected sources on hold**, select **Specify number of days to hold items relative to their received date**, and then type **720**.
22. Select **Finish**.
23. Select **Close**.


#### Task 4: Prepare for the next module
  
- When you are finished with the lab, keep all the virtual machines running. You will need them in their current state for the next module.

> **Result**: After completing this exercise, you should have configured the compliance featuresâ€”message archiving, and DLP.


### Review question(s)
  
**Question** 

Before moving mailboxes to Exchange Online in a hybrid configuration, what should you verify?

**Question** 

When administering a hybrid configuration, what is the impact of adding or modifying a DLP policy?


©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  
